<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>canary</title>
    <script src="/static/vue/3.4.31/vue.global.js"></script>
    <script src="/static/axios/1.6.7/axios.min.js"></script>

    <!--  æ„Ÿè°¢ https://plnkr.co/edit/AA74u8B1DeJ1J6DB?open=lib%2Fscript.js&preview  -->
    <script src="/static/jquery/3.6.0/jquery.min.js"></script>

    <!-- BS5.1.1 CSS/JS -->
    <!-- å‡çº§åˆ°5.1   -->
    <!--    <link rel="stylesheet" href="/static/twitter-bootstrap/4.3.1/css/bootstrap.min.css">-->
    <link href="/static/bootstrap/5.1.1/bootstrap.min.css" rel="stylesheet">
    <script src="/static/bootstrap/5.1.1/bootstrap.bundle.min.js"></script>

    <!-- Latest BS-Select compiled and minified CSS/JS -->
    <link rel="stylesheet" href="/static/bootstrap-select/1.14.0-beta2/bootstrap-select.min.css">
    <script src="/static/bootstrap-select/1.14.0-beta2/bootstrap-select.min.js"></script>

    <style>

        .long-text {
            width: 550px; /* è®¾ç½®å®¹å™¨å®½åº¦ */
            white-space: nowrap; /* ä¸å…è®¸æ¢è¡Œ */
            overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
            text-overflow: ellipsis; /* æ·»åŠ çœç•¥å· */
        }

        .account-text {
            width: 220px; /* è®¾ç½®å®¹å™¨å®½åº¦ */
            white-space: nowrap; /* ä¸å…è®¸æ¢è¡Œ */
            overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
            text-overflow: ellipsis; /* æ·»åŠ çœç•¥å· */
        }

        .left-panel {
            width: 50%;
            float: left;
        }

        .right-panel {
            width: 50%;
            float: right;
        }

        .app-padding {
            margin: 30px; /* è®¾ç½®å¤–è¾¹è·ä¸º30åƒç´ ï¼Œè¿™ä¼šåˆ†åˆ«å½±å“åˆ°ä¸Šã€å³ã€ä¸‹ã€å·¦å››ä¸ªæ–¹å‘ */
        }

    </style>

</head>
<body>

<div id="app" class="app-padding">
    <div>
        <div class="left-panel">
            <form class="row g-3 needs-validation" novalidate>
                <div class="input-group mb-3" style="margin-right: 10px;">
                    <span class="input-group-text">task id</span>
                    <input type="text" class="form-control" v-model="search_task_id">
                    <span class="input-group-text">start_time</span>
                    <input type="text" class="form-control" placeholder="%Y-%m-%d %H:%M:%S" v-model="search_start_time"
                           required>
                    <span class="input-group-text">end_time</span>
                    <input type="text" class="form-control" placeholder="%Y-%m-%d %H:%M:%S" v-model="search_end_time">

                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text" style="margin-right: 2px">request_user</span>
                    <div>
                        <select class="selectpicker" multiple v-model="search_user">
                            <option v-for="one_user in user" :value="one_user" :key="one_user">
                                {{ one_user }}
                            </option>
                        </select>
                    </div>
                    <span class="input-group-text" style="margin-right: 2px; margin-left: 2px">category</span>
                    <div>
                        <select class="selectpicker" multiple v-model="search_category">
                            <option v-for="one_cate in category" :value="one_cate" :key="one_cate">
                                {{ one_cate }}
                            </option>
                        </select>
                    </div>
                    <div style="width: 50px"></div>
                    <div>
                        <button type="button" class="btn btn-dark" style="width: 150px" @click="query_data">Search
                        </button>
                    </div>

                </div>

                <div class="input-group mb-3">
                    <div style="margin-right: 2px;">
                        <select class="selectpicker" v-model="search_show_status">
                            <option v-for="ss in show_status" :value="ss.value">
                                {{ ss.label }}
                            </option>
                        </select>
                    </div>
                    <span class="input-group-text">shovel_name</span>
                    <input type="text" class="form-control" v-model="search_shovel_name"
                           required>
                    <span class="input-group-text">account_name</span>
                    <input type="text" class="form-control" placeholder="account_name%" v-model="search_account_name">
                </div>


            </form>
        </div>
        <div class="right-panel">
            <div v-if="this.todos.length <= 1">
                <!--            <div style="text-align: center">æ•¬è¯·æœŸå¾… (oï¾Ÿvï¾Ÿ)ãƒ</div>-->
                <div style="text-align: center">1911å¹´ï¼Œè‹±å›½çš„çŸ¿å·¥ä»¬å¼€å§‹æŠŠé‡‘ä¸é›€å¸¦å…¥çŸ¿äº•ã€‚</div>
                <div style="text-align: center">è¿™äº›å°é¸Ÿå¯¹ä¸€æ°§åŒ–ç¢³éå¸¸æ•æ„Ÿï¼Œå¾®é‡çš„ä¸€æ°§åŒ–ç¢³æ³„éœ²å°±ä¼šè®©å®ƒä»¬ç„¦èºã€å•¼å«ç”šè‡³æ­»äº¡ã€‚
                </div>
                <div style="text-align: center">æ‰€ä»¥ï¼Œä¸€æ—¦äº•ä¸‹çš„é‡‘ä¸é›€è¡¨ç°å¼‚æ ·ï¼ŒçŸ¿å·¥å°±å¾—çŸ¥å±é™©æ¥ä¸´ï¼Œä¼šè¿…é€Ÿé€ƒç¦»çŸ¿äº•ä¿å‘½ã€‚
                </div>
            </div>
            <div v-else>
                <div style=" float: left">
                    <div style="margin-left: 20px;margin-right: 20px;">
                        <ul class="list-group">
                            <li class="list-group-item" v-for="tgi in todos_group_task_id_info">{{ tgi }}</li>
                        </ul>
                    </div>
                </div>
                <div style="float: left">
                    <div style="margin-left: 20px;margin-right: 20px;">
                        <ul class="list-group">
                            <li class="list-group-item" v-for="tgi in todos_group_account_name_info">{{ tgi }}</li>
                        </ul>
                    </div>
                </div>
                <div style="float: left">
                    <div style="margin-left: 20px;margin-right: 20px;">
                        <ul class="list-group">
                            <li class="list-group-item" v-for="tgi in todos_group_category_info">{{ tgi }}</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <table class="table table-bordered table-striped table-hover">
        <thead>
        <tr>
            <th scope="col"></th>
            <th scope="col">shovel_info</th>
            <th scope="col">shop_info/table_name</th>
            <th scope="col">alert_info</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="todo in todos" :key="todo.id">
            <td>
                <label style="display: inline-block; width: 100%; cursor: pointer;">
                    <input type="checkbox" v-model="todo.is_ok" @change="change_clipboard">
                </label>
            </td>
            <td>
                <table class="table mb-0 table-sm">
                    <tr>
                        <td>{{ todo.shovel_project }}</td>
                        <td>{{ todo.shovel_name }}</td>
                    </tr>
                    <tr>
                        <td>path_id: {{ todo.path_id }}</td>
                        <td>
                            <div :title="todo.target_page">{{ todo.target_page }}</div>
                        </td>
                    </tr>
                    <tr>
                        <td>task_id: {{ todo.task_id }}</td>
                        <td>machine: {{ todo.machine }}</td>
                    </tr>
                    <tr v-if="todo.show_reason">
                        <td colspan="2">å¤„ç†æ—¶é—´: {{todo.finish_time}}</td>
                    </tr>
                    <tr v-if="todo.show_reason">
                        <td colspan="2">å‡ºé”™åŸå› : {{ todo.finish_reason }}</td>
                    </tr>
                </table>
            </td>
            <td>
                <table class="table mb-1 table-sm">
                    <tr>
                        <td>{{ todo.platform_code }}</td>
                        <td>{{ todo.table_names }}</td>
                    </tr>
                    <tr>
                        <td>account_id: {{ todo.account_id }}</td>
                        <td>
                            <div class="account-text" :title="todo.account_name">{{ todo.account_name }}</div>
                        </td>
                    </tr>
                    <tr>
                        <td>shop_id: {{ todo.shop_id }}</td>
                        <td>
                            <div class="account-text" :title="todo.shop_name">{{ todo.shop_name }}</div>
                        </td>
                    </tr>
                </table>
            </td>
            <td>
                <table class="table mb-2 table-sm">
                    <tr>
                        <td colspan="2">
                            <div class="long-text" :title="todo.reason">{{ todo.reason }}</div>
                        </td>
                    </tr>
                    <tr>
                        <td>{{ todo.category }}</td>
                        <td>alert_time: {{ todo.alert_time }}</td>
                    </tr>
                    <tr>
                        <td>request_user: {{ todo.request_user }}</td>
                        <td>alert_id: {{ todo.alert_id }}</td>
                    </tr>
                </table>
            </td>
        </tr>
        </tbody>
    </table>

    <div>
        <div class="left-panel">
            <div class="d-flex justify-content-start">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" v-model="all_checked" @click="toggle_all"/>
                    <label class="form-check-label">å…¨é€‰</label>
                </div>
                <div style="width: 50px;"></div>
                <div class="input-group mb-3" style="width: 450px;">
                    <span class="input-group-text">å‡ºé”™åŸå› </span>
                    <input type="text" class="form-control" v-model="finish_reason" @input="change_clipboard"
                           placeholder="åŒ…å«ã€Œæ•°æ®å»¶è¿Ÿã€,ã€Œä¸‹çº¿ã€æ—¶, æœ‰æƒŠå–œ" @blur="copy_to_clipboard">
                </div>
                <div style="width: 50px;"></div>
                <button type="button" class="btn btn-success" style="width: 150px; height: 40px;" @click="finish_data">
                    å·²æ‰¹
                </button>
            </div>
        </div>
        <div class="right-panel">
            <div v-if="clipboard_info !== ''">
                <div class="card" style="width: 28rem;">
                    <div class="card-header">
                        ç‚¹å‡»ç©ºç™½å¤„è‡ªåŠ¨å¤åˆ¶, å»å‘é€šçŸ¥å§
                    </div>
                    <div class="card-body">
                        <div v-for="cinfo in clipboard_info_lst"> {{ cinfo }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
<script type="module">
    const {createApp, ref} = Vue
    const loading = 'æ­£åœ¨åŠ è½½æ•°æ®, è¯·ç¨å€™  (ï¿£oï¿£) . z Z'
    const empty_lst = [
        'æ´»å¹²å®Œäº†, ä¼‘æ¯ä¼‘æ¯ (ï½ï¿£â–½ï¿£)ï½', "æŸ¥è¯¢ç»“æœä¸ºç©º (>'-'<)",
        'æ´»å¹²å®Œäº†, ä¼‘æ¯ä¼‘æ¯ \\(ï¿£ï¸¶ï¿£*\\))', "æŸ¥è¯¢ç»“æœä¸ºç©º (/â–½ï¼¼)",
        'æ´»å¹²å®Œäº†, ä¼‘æ¯ä¼‘æ¯ ãƒ¾(â€¢Ï‰â€¢`)o', "æŸ¥è¯¢ç»“æœä¸ºç©º Ô…(Â¯ï¹ƒÂ¯Ô…)",
        'æ´»å¹²å®Œäº†, ä¼‘æ¯ä¼‘æ¯ (ï½¡ï½¥âˆ€ï½¥)ï¾‰ï¾', "æŸ¥è¯¢ç»“æœä¸ºç©º Â¯\\_(ãƒ„)_/Â¯",
    ]

    const app = createApp({
        // el: '#app',
        data() {
            return {
                res_todos: [],  // æŸ¥è¯¢å“åº”æ•°æ®
                todos: [  // é¡µé¢å±•ç¤ºæ•°æ®
                    {id: -1, shovel_project: loading, platform_code: loading, reason: loading},
                ],
                todos_group_account_name_info: [], // è´¦å·åˆ†ç»„
                todos_group_task_id_info: [],  // ä»»åŠ¡idåˆ†ç»„
                todos_group_category_info: [],  // ç±»åˆ«åˆ†ç»„
                search_user: [],
                user: [
                    "qhpeng", "zhchen8", "hchen23", "gfzhou",
                    "ytzheng2", "sbzhang1", "yqzhang2", "sxzhang1",
                    "fwang-kf",
                ],
                search_task_id: '',
                search_start_time: '',
                search_end_time: '',
                search_category: [
                    "Cookie Invalidated", "Target Resource Lost", "Shovel Error", "Third Service Error"
                ],
                show_status: [
                    {value: '1', label: 'only âœ”'},
                    {value: '0', label: 'all'},
                    {value: '-1', label: 'only ğŸ”²'},
                ],
                search_show_status: '-1',
                search_shovel_name: '',
                search_account_name: '',
                category: [
                    // info
                    "Target Resource Null",

                    // notice
                    "Resource Delay",
                    "SMS Required",

                    // warning
                    "Cookie Invalidated",
                    "Sliding Required",
                    "Target Resource Strange",

                    // Error
                    "BiDp Open Api Unreachable",
                    "Leqee EE Open Api Error",
                    "Shovel Error",
                    "Shovel Not Found",
                    "Elihu Open Api Unreachable",
                    "Mizar Open Api Unreachable",
                    "Third Service Error",
                    "ETL Open Api Unreachable",

                    // Fatal
                    "Account Not Passable",
                    "Account Not Permitted",
                    "Target Resource Lost",

                ],
                all_checked: false,
                finish_show: false,
                finish_reason: '',
                finish_msg: '',

                clipboard_info: '',
                clipboard_info_lst: [],
                clipboard_info_set: new Set(),
            }
        },
        created() {
            const start_time = new Date();
            start_time.setDate(start_time.getDate() - 3);
            this.search_start_time = start_time.toISOString().slice(0, 10) + ' 00:00:00'; // è½¬æ¢ä¸º'YYYY-MM-DD'æ ¼å¼çš„å­—ç¬¦ä¸²
        },
        mounted() {
            this.load_user();
            this.load_category();
            this.query_data();
        },
        methods: {
            query_data() {
                axios.post('/api_canary_query', {
                    task_id: this.search_task_id,
                    start_time: this.search_start_time,
                    end_time: this.search_end_time,
                    category: this.search_category,
                    is_ok: this.search_show_status,
                    search_user: this.search_user,
                    search_shovel_name: this.search_shovel_name,
                    search_account_name: this.search_account_name,
                }, {headers: {'Content-Type': 'application/json'}})
                    .then(response => {
                        this.res_todos = response.data;
                        this.transfer_todo();
                        this.save_user();
                        this.save_category();
                    })
                    .catch(error => {
                        console.error('Error fetching todos:', error);
                        alert(error);
                    });
            },
            transfer_todo() {
                this.todos = []
                for (let i = 0; i < this.res_todos.length; i++) {
                    this.todos.push({
                        ...this.res_todos[i],
                        is_ok: Boolean(this.res_todos[i].finish_time),
                        show_reason: Boolean(this.res_todos[i].finish_time),
                    })
                }
                if (this.todos.length === 0) {
                    const randomIndex = Math.floor(Math.random() * empty_lst.length);
                    const empty = empty_lst[randomIndex];
                    this.todos.push({id: -1, shovel_project: empty, platform_code: empty, reason: empty})
                }
                this.res_todos = [];
                // è½¬åŒ–èšåˆtodos
                this.todos_group_account_name_info = [];
                this.todos_group_account_name_info.push("è´¦å·åˆ†ç»„: ")
                this.todos_group_task_id_info = [];
                this.todos_group_task_id_info.push("taskæ€»æ•°é‡: " + this.todos.length)
                this.todos_group_category_info = [];
                this.todos_group_category_info.push("ç±»åˆ«åˆ†ç»„: ")

                // ç»Ÿè®¡ account_name task_id category æ¯ç§çš„æ•°é‡
                const account_name_cnt = {};
                const task_id_cnt = {};
                const category_cnt = {};
                this.todos.forEach(item => {
                    if (account_name_cnt[item.account_name]) {
                        account_name_cnt[item.account_name]++;
                    } else {
                        account_name_cnt[item.account_name] = 1;
                    }
                    if (task_id_cnt[item.task_id]) {
                        task_id_cnt[item.task_id]++;
                    } else {
                        task_id_cnt[item.task_id] = 1;
                    }
                    if (category_cnt[item.category]) {
                        category_cnt[item.category]++;
                    } else {
                        category_cnt[item.category] = 1;
                    }
                });
                const show_num = 3;
                Object.entries(account_name_cnt).some(([key, value], index) => {
                    if (index < show_num) {
                        this.todos_group_account_name_info.push(String(key) + ": " + String(value))
                    } else {
                        this.todos_group_account_name_info.push("âš å±•ç¤ºä¸ä¸‹äº† o(Tãƒ˜To)")
                        return true;
                    }
                })
                Object.entries(task_id_cnt).some(([key, value], index) => {
                    if (index < show_num) {
                        this.todos_group_task_id_info.push(String(key) + ": " + String(value))
                    } else {
                        this.todos_group_task_id_info.push("âš å±•ç¤ºä¸ä¸‹äº† â‰§ ï¹ â‰¦")
                        return true;
                    }
                })
                Object.entries(category_cnt).some(([key, value], index) => {
                    if (index < show_num) {
                        this.todos_group_category_info.push(String(key) + ": " + String(value))
                    } else {
                        this.todos_group_category_info.push("âš å±•ç¤ºä¸ä¸‹äº† /(ã„’oã„’)/~~")
                        return true;
                    }
                })


            },
            toggle_all() {
                this.all_checked = !this.all_checked;
                this.todos.forEach((todo) => (todo.is_ok = this.all_checked));
                this.change_clipboard();
            },
            finish_data() {
                const send_data = [];
                this.todos.forEach((todo) => {
                    send_data.push({'id': todo.id, 'is_ok': todo.is_ok, 'finish_time': todo.finish_time})
                })
                axios.post('/api_canary_finish', {
                    send_data: send_data,
                    finish_reason: this.finish_reason,
                }, {headers: {'Content-Type': 'application/json'}})
                    .then(response => {
                        this.query_data();
                        this.all_checked = false;
                        this.finish_reason = '';
                        this.change_clipboard();
                    })
                    .catch(error => {
                        console.error('Error fetching todos:', error);
                        alert(error);
                    });
            },
            change_clipboard() {
                if (this.finish_reason.includes("æ•°æ®å»¶è¿Ÿ") || this.finish_reason.includes("ä¸‹çº¿")) {
                    this.clipboard_info = '';
                    this.clipboard_info_lst = [];
                    this.clipboard_info_set = new Set();
                    this.todos.forEach((todo) => {
                        if ((todo.finish_time === null || todo.finish_time === 'null') && todo.is_ok === true) {
                            const tn = "è¡¨å: " + todo.table_names;
                            const pi = "path id: " + todo.path_id;
                            const tn_pi = tn + pi
                            if (!this.clipboard_info_set.has(tn_pi)) {
                                this.clipboard_info += "\n" + tn;
                                this.clipboard_info_lst.push(tn);
                                this.clipboard_info += "\n" + pi;
                                this.clipboard_info_lst.push(pi);
                                this.clipboard_info += "\n";
                                this.clipboard_info_lst.push("----------------");
                                this.clipboard_info_set.add(tn_pi)
                            }
                        }
                    })
                    if (this.clipboard_info === "") {
                        // this.clipboard_info = "è¯·å‹¾é€‰æŠ¥è­¦ä¿¡æ¯";
                        // this.clipboard_info_lst = ["è¯·å‹¾é€‰æŠ¥è­¦ä¿¡æ¯"];
                        return
                    }

                    const rs = "åŸå› : " + this.finish_reason;
                    this.clipboard_info += "\n" + rs;
                    this.clipboard_info_lst.push(rs);

                    const tl = "ã€æ•°æ®å»¶è¿Ÿé€šçŸ¥ã€‘";
                    this.clipboard_info = tl + this.clipboard_info;
                    this.clipboard_info_lst.unshift(tl);

                } else {
                    this.clipboard_info = '';
                }
            },
            copy_to_clipboard() {
                if (this.clipboard_info !== '' || this.clipboard_info !== 'è¯·å‹¾é€‰æŠ¥è­¦ä¿¡æ¯') {
                    navigator.clipboard.writeText(this.clipboard_info).then(() => {
                        console.log('æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }, (err) => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                    });
                }

            },
            save_user() {
                localStorage.setItem('local_user', JSON.stringify(this.search_user))
            },
            load_user() {
                let local_user = localStorage.getItem("local_user")
                if (local_user === null) {
                    this.search_user = []
                } else {
                    this.search_user = JSON.parse(local_user)
                }
            },
            save_category() {
                localStorage.setItem('local_category', JSON.stringify(this.search_category))
            },
            load_category() {
                let local_user = localStorage.getItem("local_category")
                if (local_user === null) {
                    this.search_category = []
                } else {
                    this.search_category = JSON.parse(local_user)
                }
            },
        }
    });
    app.mount('#app')
</script>
</body>
</html>